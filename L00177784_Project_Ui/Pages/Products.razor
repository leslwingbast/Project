@page "/products"

@using System.Text.Json
@using System.Text.Json.Serialization
@inject IHttpClientFactory ClientFactory


<PageTitle>Products</PageTitle>

<h1>Products</h1>


<div class="row">
    <input type="text" placeholder="Search by Product ID, Name, Barcode or Sku" minlength="3"
           @bind="filterProduct"
           @bind:event="oninput" 
    />
</div>
@if (filteredProducts == null)
{
    <p>Loading ....</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <td>ID</td>
                <td>Sku</td>
                <td>Name</td>
                <td>Barcode</td>
                <td>Group</td>
            </tr>
        </thead>
        <tbody>
            @foreach (var product in filteredProducts)
            {
            if (!IsVisible(product))
                    continue;
            <tr>
                <td>@product.id</td>
                <td>@product.sku</td>
                <td>@product.name</td>
                <td>@product.barcode</td>
                <td>@product.loyaltyGroup_Id</td>
            </tr>
            }
        </tbody>
    </table>
}


@code {
    /// <summary>
    /// Lists for full list of products and filtered products
    /// </summary>
    private List<ProductData>? allProducts, filteredProducts = new List<ProductData>();

    /// <summary>
    /// String to hold text when searching for a product
    /// </summary>
    string filterProduct = string.Empty;

    /// <summary>
    /// Endpoint for all getting products
    /// </summary>
    private readonly string AllProducts = "https://localhost:7240/api/Products";

    /// <summary>
    /// Initialisation of the page
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        await InitialAPICall(AllProducts);
        filteredProducts = allProducts;
    }



    /// <summary>
    /// Initial API call to load all products
    /// </summary>
    /// <param name="endpoint">Endpoint to be called by the API</param>
    /// <returns></returns>
    private async Task InitialAPICall(string endpoint)
    {
        var request = new HttpRequestMessage(
                        HttpMethod.Get,
                        endpoint
                    );

        var client = ClientFactory.CreateClient();

        var response = await client.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            var stream = await response.Content.ReadAsStreamAsync();
            allProducts = await JsonSerializer.DeserializeAsync<List<ProductData>>(stream);
        }
        else
        {
            // TODO: Handle error - display message
            Console.WriteLine("Something went wrong - Please try again later...");
        }
        StateHasChanged();
    }

    /// <summary>
    /// Method for searching products based on multiple values
    /// </summary>
    /// <param name="productSearch">Product to be checked</param>
    /// <returns></returns>
    private bool IsVisible(ProductData productSearch)
    {
        if(string.IsNullOrEmpty(filterProduct))
        {
            return true;
        }

        if (productSearch.name.Contains(filterProduct, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }
        else if(productSearch.barcode != null)
        {
            if (productSearch.barcode.Contains(filterProduct, StringComparison.OrdinalIgnoreCase))
                return true;
        }
        else if(productSearch.sku != null)
        {
            var skuString = productSearch.sku.ToString();
            if(skuString != null)
            {
                if (skuString.Contains(filterProduct, StringComparison.OrdinalIgnoreCase))
                    return true;
            }
        }
        else if (productSearch.id.ToString().Contains(filterProduct, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

        return false;
    }


    /// <summary>
    /// Class for products
    /// </summary>
    public class ProductData
    {
        public int id { get; set; }
        public string? barcode { get; set; }
        public int? sku { get; set; }
        public string name { get; set; } = string.Empty;
        public int loyaltyGroup_Id { get; set; }
    
    }
}
