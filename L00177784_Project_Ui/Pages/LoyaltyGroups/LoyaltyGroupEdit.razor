@page "/loyaltygroups/edit/{loyaltyId:int}"

@using Data
@using System.Text
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@using BootstrapBlazor.Components
@inject IHttpClientFactory ClientFactory
@inject NavigationManager navManager
@inject IJSRuntime js

<h3>LoyaltyGroupEdit</h3>
<div class="align-content-center">   
    <EditForm Model="@editLoyaltyGroup" OnValidSubmit="@EditLoyaltyGroup">
    <DataAnnotationsValidator />
    <div class="container alert-secondary p-4 col-6 mx-auto" style="min-width: 300px;">
        <form>
            <div class="row-1 my-1">
                <div class="form-group col">
                    <label for="name">Loyalty Group Name:</label>
                    <input type="text" class="form-control" id="inputProductName" @bind="@editLoyaltyGroup!.name" placeholder="Loyalty Group Name">
                    <ValidationMessage For="@(()=> editLoyaltyGroup.name)" />
                </div>
            </div>
            <div class="row-1 my-2">
                <div class="form-group col">
                    <label for="threshold">Number of items to be purchased to receive free item</label>
                    <div class="col-4" style="width: 150px;">
                        <BootstrapInputNumber ShowButton="true" Value="@editLoyaltyGroup.threshold" Min="0"/>
                    </div>
                </div>
            </div>
                <div class="row my-2">
                    <label for="image">Image:</label>
                    <div class="col-sm-7">
                        <div class="images-item">
                            <ImageViewer Url="@image"
                                         FitMode="ObjectFitMode.Contain" style="max-width: 200px;" />
                        </div>
                    </div>
                    <div class="col" style="min-width:40%">
                        <div class="row">
                            <label style="font-size:smaller">Suggested Image Dimensions:</label>
                            <label style="font-size:smaller">200px x 100px</label>
                        </div>
                        <br/>
                        <div class="row">
                            
                            <div class="btn btn-light" style="max-width:150px" @onclick="ReplaceImage">Replace Image</div>
                            
                        </div>
                    </div>

                </div>
            <div class="row-1 my-1">
                <div class="form-group col">
                    <label for="products">Products:</label>
                    <MultiSelect Items="@items" Color="Color.Dark" @bind-Value="@SelectedValues" style="font-size:small;" />
                </div>
            </div>
            
        </form>
        <div class="row my-1">
            <button type="submit" class="btn col-sm mt-4 mx-1 btn-success">
                Submit
            </button>
            <div type="submit" class="btn btn-warning col-sm mt-4 mx-1" @onclick="Cancel">Cancel</div>
        </div>
    </div>
</EditForm>




</div>

@code {
    /// <summary>
    /// Loyalty Id as parameter of loyalty group to be updated
    /// </summary>
    [Parameter]
    public int loyaltyId { get; set; }

    private string image = "/images/placeholder.png";

    /// <summary>
    /// Loyalty group to be edited
    /// </summary>
    private LoyaltyGroup editLoyaltyGroup = new LoyaltyGroup();

    /// <summary>
    /// List of SelectedItem type to populate options in multiselect
    /// </summary>
    public List<SelectedItem> items { get; set; } = new List<SelectedItem>();

    /// <summary>
    /// List of SelectedItem type to work with BlazorBootstrap multiselect
    /// </summary>
    public List<SelectedItem> dataSource { get; set; } = new List<SelectedItem>();

    /// <summary>
    /// Lost of current products that are connected to the current loyalty scheme
    /// </summary>
    public List<String> currentProducts { get; set; } = new List<string>();

    /// <summary>
    /// List of products used to populate options
    /// </summary>
    private List<Product> products = new List<Product>();

    /// <summary>
    /// Selected values in the multiselect
    /// </summary>
    private IEnumerable<string> SelectedValues { get; set; } = Enumerable.Empty<string>();

    /// <summary>
    /// Initialisation of page which will call methods to update loyalty group and products
    /// </summary>
    /// <returns>Done</returns>
    protected override async Task OnInitializedAsync()
    {
        await GetLoyaltyGroup(loyaltyId);
        await ProductAPICall();
        SelectedValues = currentProducts.ToList();
    }

    /// <summary>
    /// Gets the current loyalty scheme
    /// </summary>
    /// <param name="loyaltyId">Id of loyalty scheme</param>
    /// <returns>Done</returns>
    private async Task GetLoyaltyGroup(int loyaltyId)
    {
        string endpoint = "https://localhost:7240/api/LoyaltyGroups/" + loyaltyId;

        var client = ClientFactory.CreateClient();

        var request = new HttpRequestMessage(
                        HttpMethod.Get,
                        endpoint

                    );
        var response = await client.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            var responseData = await response.Content.ReadAsStringAsync();

            editLoyaltyGroup = JsonConvert.DeserializeObject<LoyaltyGroup>(responseData)!;
            @if(!string.IsNullOrEmpty(editLoyaltyGroup.image))
            {
                image = string.Concat("/images/",editLoyaltyGroup.image);
            }
        }
        else
        {
            await js.InvokeVoidAsync("alert", "There was a problem retrieving this loyalty scheme");
        }

    }

    /// <summary>
    /// Endpoint to get products
    /// </summary>
    private readonly string allProductsEndpoint = "https://localhost:7240/api/Products";

    /// <summary>
    /// Initial API call to load all products for multiselect
    /// Populates a list of products that are currently matching the loyalty shceme
    /// </summary>
    /// <param name="endpoint">Endpoint to be called by the API</param>
    /// <returns></returns>
    private async Task ProductAPICall()
    {
        var request = new HttpRequestMessage(
                        HttpMethod.Get,
                        allProductsEndpoint
                    );

        var client = ClientFactory.CreateClient();

        var response = await client.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            var responseData = await response.Content.ReadAsStringAsync();
            products = JsonConvert.DeserializeObject<List<Product>>(responseData);
            foreach (var product in products!)
            {
                dataSource.Add(new SelectedItem
                    {
                        Value = product.id.ToString(),
                        Text = product.name
                    });

                if (product.loyaltyGroup_Id == editLoyaltyGroup.id)
                {
                    currentProducts.Add(product.id.ToString());
                }
            }
            items = GenerateDataSource(dataSource);

        }
        else
        {
            // TODO: Handle error - display message
            await js.InvokeVoidAsync("alert", "There was a prolem retrieving the products");
        }
        StateHasChanged();
    }

    /// <summary>
    /// Populates the list of products in the multiselect
    /// </summary>
    /// <param name="source">List of products id and name</param>
    /// <returns>List of selecteditem type</returns>
    private static List<SelectedItem> GenerateDataSource(List<SelectedItem> source) => source.Select(i => new SelectedItem(i.Value, i.Text)).ToList();


    /// <summary>
    /// Updates loyalty group with form details
    /// </summary>
    /// <returns>Done</returns>
    private async Task EditLoyaltyGroup()
    {

        foreach(Product updateProduct in products)
        {
            if(SelectedValues.Contains(updateProduct.id.ToString()))
            {
                if(updateProduct.loyaltyGroup_Id != editLoyaltyGroup.id)
                {
                    updateProduct.loyaltyGroup_Id = (int)editLoyaltyGroup.id!;
                    await UpdateProduct(updateProduct);
                }

            }
            else if(updateProduct.loyaltyGroup_Id == editLoyaltyGroup.id)
            {
                updateProduct.loyaltyGroup_Id = null;
                await UpdateProduct(updateProduct);
            }
        }

    }

    /// <summary>
    /// Update any products that are in not currently stored as part of the loyalty group
    /// </summary>
    /// <param name="productToUpdate">Product that needs to be updated</param>
    /// <returns>Done</returns>
    private async Task UpdateProduct(Product productToUpdate)
    {

        string endpoint = "https://localhost:7240/api/Products/" + productToUpdate.id;
        var request = new HttpRequestMessage(
            HttpMethod.Put,
            endpoint
        );

        var client = ClientFactory.CreateClient();

        // Convert new product to json
        string stringjson = JsonConvert.SerializeObject(productToUpdate);
        // Add content including new product to request
        request.Content = new StringContent(stringjson, Encoding.UTF8, "application/json");

        var response = await client.SendAsync(request);
        response.EnsureSuccessStatusCode();
        await js.InvokeVoidAsync("alert", "Updated Product");
    }

    private void ReplaceImage()
    {
        js.InvokeVoidAsync("alert", "REplace Image");
    }

    /// <summary>
    /// Returns user to loyalty groups page
    /// </summary>
    private void Cancel()
    {
        navManager.NavigateTo("/loyaltygroups");
    }
}
